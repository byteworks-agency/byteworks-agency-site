---
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  lang?: 'en' | 'es';
}

const {
  title = 'Admin Panel',
  description = 'Private admin area',
  image = '/og-image.png',
  lang = 'en',
} = Astro.props as Props;

const pathname = Astro.url.pathname || '/admin';
const isActive = (href: string) => {
  if (href === '/admin') return pathname === '/admin';
  return pathname === href || pathname.startsWith(href + '/');
};
---

<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  </head>
  <body class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-text-secondary">
    <header class="relative z-50 flex items-center justify-between whitespace-nowrap border-b border-slate-200 dark:border-slate-700 px-4 sm:px-6 lg:px-10 py-3 bg-white dark:bg-background-dark">
      <div class="flex items-center gap-3 text-slate-900 dark:text-white">
        <button id="hamburgerBtn" type="button" class="md:hidden inline-flex items-center justify-center w-9 h-9 rounded hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Toggle menu" aria-expanded="false">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <img src="/logo.png" alt="Logo" width="28" height="28" class="block" />
        <h2 class="text-lg font-bold">Dashboard</h2>
      </div>
      <div class="flex items-center gap-2">
        <button id="logoutBtn" type="button" class="flex min-w-[84px] items-center justify-center rounded-lg h-10 px-4 border text-sm font-bold">Logout</button>
      </div>
    </header>
    <!-- Mobile sidebar backdrop -->
    <div id="sidebarBackdrop" class="fixed inset-0 bg-black/40 z-[50] md:hidden hidden" onclick="closeSidebarMobile()"></div>
    <div class="flex">
      <aside id="adminSidebar" class="fixed md:static inset-y-0 left-0 z-[60] w-64 shrink-0 border-r border-slate-200 dark:border-slate-700 bg-white dark:bg-background-dark md:min-h-[calc(100vh-56px)] transition-transform duration-200 ease-out transform -translate-x-full md:translate-x-0">
        <div class="p-3 flex items-center justify-between">
          <button type="button" class="md:hidden inline-flex items-center justify-center w-8 h-8 rounded hover:bg-slate-100 dark:hover:bg-slate-800" onclick="closeSidebarMobile()" aria-label="Close menu">
            <span class="material-symbols-outlined">close</span>
          </button>
          <button id="sidebarToggleBtn" type="button" class="hidden md:inline-flex items-center justify-center w-8 h-8 rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Toggle sidebar">
            <span id="sidebarToggleIcon" class="material-symbols-outlined text-slate-700 dark:text-slate-300">chevron_left</span>
          </button>
        </div>
        <nav class="p-4 pt-0 space-y-1">
          <a href="#" id="newQuoteLink" class={`admin-link bg-[rgba(17,115,212,0.10)] text-[rgb(17,115,212)] font-semibold` }>
            <span class="material-symbols-outlined">request_quote</span>
            <span class="label">New Quote</span>
          </a>
          <a href="/admin" title="Dashboard" class={`admin-link ${isActive('/admin') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">dashboard</span>
            <span class="label">Dashboard</span>
          </a>
          <a href="/admin/quotes" title="Quotes" class={`admin-link ${isActive('/admin/quotes') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">receipt_long</span>
            <span class="label">Quotes</span>
          </a>
          <a href="/admin/billing/invoices" title="Invoices" class={`admin-link ${isActive('/admin/billing/invoices') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">description</span>
            <span class="label">Invoices</span>
          </a>
          <a href="/admin/plans" title="Plans & Add-ons" class={`admin-link ${isActive('/admin/plans') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">inventory_2</span>
            <span class="label">Plans & Add-ons</span>
          </a>
        </nav>
      </aside>
      <main class="flex-1 px-4 sm:px-6 lg:px-10 py-6 lg:py-8">
        <slot />
      </main>
    </div>
    <!-- New Quote Modal -->
    <div id="nwq_modal" class="hidden fixed inset-0 z-50 items-center justify-center">
      <div class="absolute inset-0 bg-black/50" onclick="nwq_close()"></div>
      <div class="relative bg-white dark:bg-background-dark rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 w-[95vw] max-w-3xl mx-auto p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 id="nwq_title" class="text-lg font-bold">Quote #</h3>
          <button class="text-sm px-2 py-1 border rounded" onclick="nwq_close()">Close</button>
        </div>
        <form class="grid grid-cols-1 md:grid-cols-6 gap-3" onsubmit="event.preventDefault(); nwq_quickCreate();">
          <div id="nwq_enquiryId_wrap" class="md:col-span-2">
            <label class="block text-xs mb-1">Request ID (optional)</label>
            <input id="nwq_enquiryId" placeholder="Auto-generated if left blank" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400" />
          </div>
          <div>
            <label class="block text-xs mb-1">Customer Name</label>
            <input id="nwq_billToName" placeholder="John Doe" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400" />
          </div>
          <div>
            <label class="block text-xs mb-1">Email</label>
            <input id="nwq_billToEmail" type="email" placeholder="john@example.com" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400" />
          </div>
          <div>
            <label class="block text-xs mb-1">Phone</label>
            <input id="nwq_billToPhone" type="tel" placeholder="+1 555 123 4567" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400" />
          </div>
          <div>
            <label class="block text-xs mb-1">Currency</label>
            <select id="nwq_currency" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100">
              <option value="TTD">TTD</option>
              <option value="USD">USD</option>
            </select>
          </div>
          <div class="md:col-span-6">
            <div id="nwq_items" class="grid md:grid-cols-6 gap-2">
              <div class="md:col-span-4">
                <label class="block text-xs mb-1">Item Description</label>
                <input data-nwq="desc" placeholder="Service" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400" />
              </div>
              <div>
                <label class="block text-xs mb-1">Qty</label>
                <input data-nwq="qty" type="number" step="0.01" value="1" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100" />
              </div>
              <div>
                <label class="block text-xs mb-1">Unit Price</label>
                <input data-nwq="price" type="number" step="0.01" value="0" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100" />
              </div>
            </div>
            <div class="mt-2 flex gap-2">
              <button type="button" class="px-3 py-2 border rounded text-sm" onclick="nwq_addItem()">Add Item</button>
              <button class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold">Create quote</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <style is:inline>
      #adminSidebar.collapsed { width: 60px; }
      #adminSidebar .label { display: inline; }
      #adminSidebar.collapsed .label { display: none; }
      #adminSidebar nav a.admin-link { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem; color: rgb(51 65 85); }
      #adminSidebar nav a.admin-link:hover { background: rgba(148,163,184,0.15); }
      .dark #adminSidebar nav a.admin-link { color: rgb(203 213 225); }
      #adminSidebar nav a.admin-link.active { background: rgba(17,115,212,0.1); color: rgb(17,115,212); font-weight: 600; }
      #adminSidebar.collapsed nav a.admin-link { justify-content: center; }
      #sidebarToggleIcon { transition: transform 150ms ease; }
      #adminSidebar.collapsed #sidebarToggleIcon { transform: rotate(180deg); }
      @media (min-width: 768px) {
        #adminSidebar { transform: none !important; }
        #sidebarBackdrop { display: none !important; }
      }
    </style>
    <script is:inline>
      // Embed company code for client-side ref generation
      const COMPANY_CODE = {JSON.stringify(import.meta.env.PUBLIC_COMPANY_CODE || 'BW')};
      function nwq_generateRef(){
        const dt = new Date();
        const y = dt.getUTCFullYear();
        const m = String(dt.getUTCMonth()+1).padStart(2,'0');
        const prefix = `${COMPANY_CODE}-${y}${m}`;
        const rand = Math.random().toString(36).slice(2,6).toUpperCase();
        return `${prefix}-${rand}`;
      }
      async function logout(){
        try { await fetch('/api/auth/logout', { method: 'POST' }); location.replace('/auth/signin'); } catch {}
      }
      // Wire logout button and expose (for safety)
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
      window.logout = logout;
      (function(){
        const key = 'bwAdminSidebarCollapsed';
        const aside = document.getElementById('adminSidebar');
        const icon = document.getElementById('sidebarToggleIcon');
        function setIcon(){ if (!icon || !aside) return; icon.textContent = aside.classList.contains('collapsed') ? 'chevron_right' : 'chevron_left'; }
        function setCollapsed(v){ if (!aside) return; aside.classList.toggle('collapsed', v); localStorage.setItem(key, v ? '1' : '0'); setIcon(); }
        const stored = localStorage.getItem(key);
        if (stored === '1') setCollapsed(true); else setIcon();
        window.toggleSidebar = function(){ setCollapsed(!(aside?.classList.contains('collapsed'))); };
        const btn = document.getElementById('sidebarToggleBtn');
        if (btn) btn.addEventListener('click', function(ev){ ev.preventDefault(); ev.stopPropagation(); window.toggleSidebar(); });
      })();
      (function(){
        const aside = document.getElementById('adminSidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        function open(){
          if (!aside) return;
          // Ensure full width on mobile when opening
          if (window.innerWidth < 768) aside.classList.remove('collapsed');
          aside.classList.remove('-translate-x-full');
          backdrop?.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
          const hb = document.getElementById('hamburgerBtn');
          if (hb) hb.setAttribute('aria-expanded', 'true');
        }
        function close(){ aside?.classList.add('-translate-x-full'); backdrop?.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); const hb = document.getElementById('hamburgerBtn'); if (hb) hb.setAttribute('aria-expanded','false'); }
        function toggle(){ if (!aside) return; if (aside.classList.contains('-translate-x-full')) open(); else close(); }
        window.openSidebarMobile = open;
        window.closeSidebarMobile = close;
        window.toggleSidebarMobile = toggle;
        window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); });
        window.addEventListener('resize', ()=>{ if (window.innerWidth >= 768) close(); });
        // Wire hamburger and new quote link
        const hb = document.getElementById('hamburgerBtn');
        if (hb) hb.addEventListener('click', (e)=>{ e.preventDefault(); toggle(); });
        const nq = document.getElementById('newQuoteLink');
        if (nq) nq.addEventListener('click', (e)=>{ e.preventDefault(); try { window.nwq_open && window.nwq_open(); } catch {} close(); });
      })();
      function nwq_open(prefill){
        const m = document.getElementById('nwq_modal');
        m?.classList.remove('hidden');
        m?.classList.add('flex');
        const idWrap = document.getElementById('nwq_enquiryId_wrap');
        const nameEl = document.getElementById('nwq_billToName');
        const emailEl = document.getElementById('nwq_billToEmail');
        const phoneEl = document.getElementById('nwq_billToPhone');
        const idEl = document.getElementById('nwq_enquiryId');
        const titleEl = document.getElementById('nwq_title');
        // reset defaults
        if (!prefill) {
          idWrap?.classList.remove('hidden');
          if (nameEl) nameEl.value = '';
          if (emailEl) emailEl.value = '';
          if (phoneEl) phoneEl.value = '';
          const gen = nwq_generateRef();
          if (idEl) idEl.value = gen;
          window.nwq_enquiryIdOverride = gen;
          if (titleEl) titleEl.textContent = `Quote #${gen}`;
          setTimeout(()=> (idEl?.focus?.()), 0);
          return;
        }
        // hide ID (auto-generated) when invoked from leads
        idWrap?.classList.add('hidden');
        if (nameEl && prefill.name) nameEl.value = prefill.name;
        if (emailEl && prefill.email) emailEl.value = prefill.email;
        if (phoneEl && prefill.phone) phoneEl.value = prefill.phone;
        // allow passing a precomputed company reference id
        const rid = prefill.enquiryId || nwq_generateRef();
        window.nwq_enquiryIdOverride = rid;
        if (titleEl) titleEl.textContent = `Quote #${rid}`;
        setTimeout(()=> (nameEl?.focus?.()), 0);
      }
      function nwq_close(){
        const m = document.getElementById('nwq_modal');
        m?.classList.add('hidden');
        m?.classList.remove('flex');
      }
      async function nwq_apiCreate(id, extras = {}){
        const qs = id && id.trim() ? `?enquiryId=${encodeURIComponent(id.trim())}` : '';
        const res = await fetch(`/api/quotes/create${qs}` , {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(extras)
        });
        return res.json();
      }
      function nwq_gatherItems(){
        const container = document.getElementById('nwq_items');
        const descs = container.querySelectorAll('input[data-nwq="desc"]');
        const qtys = container.querySelectorAll('input[data-nwq="qty"]');
        const prices = container.querySelectorAll('input[data-nwq="price"]');
        const items = [];
        for (let i=0;i<descs.length;i++){
          const description = (descs[i].value||'').trim();
          if (!description) continue;
          const qtyN = Number(qtys[i]?.value||'0');
          const priceN = Number(prices[i]?.value||'0');
          const qty = (qtyN > 0 ? qtyN : 0).toFixed(2);
          const unitPrice = (priceN >= 0 ? priceN : 0).toFixed(2);
          items.push({ description, qty, unitPrice, sort: i+1 });
        }
        return items;
      }
      async function nwq_createFrom(id){
        const billToName = (document.getElementById('nwq_billToName')).value.trim() || undefined;
        const billToEmail = (document.getElementById('nwq_billToEmail')).value.trim() || undefined;
        const billToPhone = (document.getElementById('nwq_billToPhone')).value.trim() || undefined;
        const currency = (document.getElementById('nwq_currency')).value || undefined;
        const items = nwq_gatherItems();
        if (items.length === 0) { alert('Add at least one item with description.'); return; }
        const invalid = items.find(it => Number(it.qty) <= 0 || Number(it.unitPrice) < 0);
        if (invalid) { alert('Qty must be > 0 and price >= 0'); return; }
        const json = await nwq_apiCreate(id, { billToName, billToEmail, billToPhone, currency, items });
        if (!json?.ok) { alert('Error: '+(json?.code||'unknown')); return; }
        nwq_close();
        location.href = `/admin/quotes/${json.data.quoteId}`;
      }
      function nwq_addItem(){
        const wrap = document.getElementById('nwq_items');
        const row = document.createElement('div');
        row.className = 'md:col-span-6 grid md:grid-cols-6 gap-2';
        row.innerHTML = `
          <div class="md:col-span-4">
            <label class=\"block text-xs mb-1\">Item Description</label>
            <input data-nwq=\"desc\" placeholder=\"Service\" class=\"border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400\" />
          </div>
          <div>
            <label class=\"block text-xs mb-1\">Qty</label>
            <input data-nwq=\"qty\" type=\"number\" step=\"0.01\" value=\"1\" class=\"border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100\" />
          </div>
          <div>
            <label class=\"block text-xs mb-1\">Unit Price</label>
            <input data-nwq=\"price\" type=\"number\" step=\"0.01\" value=\"0\" class=\"border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100\" />
          </div>`;
        wrap.appendChild(row);
      }
      async function nwq_quickCreate(){
        const id = (document.getElementById('nwq_enquiryId')).value.trim();
        const finalId = id || window.nwq_enquiryIdOverride || '';
        return nwq_createFrom(finalId);
      }
      // Expose modal helpers globally for inline handlers and listeners
      window.nwq_open = nwq_open;
      window.nwq_close = nwq_close;
      window.nwq_addItem = nwq_addItem;
      window.nwq_quickCreate = nwq_quickCreate;
    </script>
  </body>
  
</html>

