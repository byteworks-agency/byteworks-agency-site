---
import '../styles/global.css';
import adminUrl from '../scripts/admin.js?url';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  lang?: 'en' | 'es';
}

const {
  title = 'Admin Panel',
  description = 'Private admin area',
  image = '/og-image.png',
  lang = 'en',
} = Astro.props as Props;

const pathname = Astro.url.pathname || '/admin';


const isActive = (href: string) => {
  if (href === '/admin') return pathname === '/admin';
  return pathname === href || pathname.startsWith(href + '/');
};

// Resolve client script to ensure correct asset path in production
// Script path handled via inline ESM import so Vite/Astro resolves it in prod
---

<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  </head>
  <body class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-text-secondary">
    <header class="relative z-50 flex items-center justify-between whitespace-nowrap border-b border-slate-200 dark:border-slate-700 px-4 sm:px-6 lg:px-10 py-3 bg-white dark:bg-background-dark">
      <div class="flex items-center gap-3 text-slate-900 dark:text-white">
        <button id="hamburgerBtn" type="button" class="md:hidden inline-flex items-center justify-center w-9 h-9 rounded hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Toggle menu" aria-expanded="false">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <img src="/logo.png" alt="Logo" width="28" height="28" class="block" />
        <h2 class="text-lg font-bold">Dashboard</h2>
      </div>
      <div class="flex items-center gap-2">
        <button id="logoutBtn" type="button" class="flex min-w-[84px] items-center justify-center rounded-lg h-10 px-4 border text-sm font-bold">Logout</button>
      </div>
    </header>
    <!-- Mobile sidebar backdrop -->
    <div id="sidebarBackdrop" class="fixed inset-0 bg-black/40 z-[50] md:hidden hidden" onclick="closeSidebarMobile()"></div>
    <div class="flex">
      <aside id="adminSidebar" class="fixed md:static inset-y-0 left-0 z-[60] w-64 shrink-0 border-r border-slate-200 dark:border-slate-700 bg-white dark:bg-background-dark md:min-h-[calc(100vh-56px)] transition-transform duration-200 ease-out transform -translate-x-full md:translate-x-0">
        <div class="p-3 flex items-center justify-between">
          <button type="button" class="md:hidden inline-flex items-center justify-center w-8 h-8 rounded hover:bg-slate-100 dark:hover:bg-slate-800" onclick="closeSidebarMobile()" aria-label="Close menu">
            <span class="material-symbols-outlined">close</span>
          </button>
          <button id="sidebarToggleBtn" type="button" class="hidden md:inline-flex items-center justify-center w-8 h-8 rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Toggle sidebar">
            <span id="sidebarToggleIcon" class="material-symbols-outlined text-slate-700 dark:text-slate-300">chevron_left</span>
          </button>
        </div>
        <nav class="p-4 pt-0 space-y-1">
          <a href="#" id="newQuoteLink" class={`admin-link bg-[rgba(17,115,212,0.10)] text-[rgb(17,115,212)] font-semibold` }>
            <span class="material-symbols-outlined">request_quote</span>
            <span class="label">New Quote</span>
          </a>
          <a href="/admin" title="Dashboard" class={`admin-link ${isActive('/admin') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">dashboard</span>
            <span class="label">Dashboard</span>
          </a>
          <a href="/admin/quotes" title="Quotes" class={`admin-link ${isActive('/admin/quotes') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">receipt_long</span>
            <span class="label">Quotes</span>
          </a>
          <a href="/admin/billing/invoices" title="Invoices" class={`admin-link ${isActive('/admin/billing/invoices') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">description</span>
            <span class="label">Invoices</span>
          </a>
          <a href="/admin/plans" title="Plans & Add-ons" class={`admin-link ${isActive('/admin/plans') ? 'active' : ''}`}>
            <span class="material-symbols-outlined">inventory_2</span>
            <span class="label">Plans & Add-ons</span>
          </a>
        </nav>
      </aside>
      <main class="flex-1 px-4 sm:px-6 lg:px-10 py-6 lg:py-8">
        <slot />
      </main>
    </div>
    <!-- New Quote Modal -->
    <div id="nwq_modal" class="hidden fixed inset-0 z-[80] items-center justify-center">
      <div class="absolute inset-0 bg-black/50" onclick="nwq_close()"></div>
      <div class="relative bg-white dark:bg-background-dark rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 w-[95vw] max-w-3xl mx-auto p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 id="nwq_title" class="text-lg font-bold">Quote #</h3>
          <button class="text-sm px-2 py-1 border rounded" onclick="nwq_close()">Close</button>
        </div>
        <form class="grid grid-cols-1 md:grid-cols-6 gap-3" onsubmit="event.preventDefault(); nwq_quickCreate();">
          <div id="nwq_enquiryId_wrap" class="md:col-span-2">
            <label class="block text-xs mb-1">Request ID (optional)</label>
            <input id="nwq_enquiryId" placeholder="Auto-generated if left blank" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400 bg-white dark:bg-background-dark dark:border-gray-700" />
          </div>
          <div>
            <label class="block text-xs mb-1">Customer Name</label>
            <input id="nwq_billToName" placeholder="John Doe" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400 bg-white dark:bg-background-dark dark:border-gray-700" />
          </div>
          <div>
            <label class="block text-xs mb-1">Email</label>
            <input id="nwq_billToEmail" type="email" placeholder="john@example.com" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400 bg-white dark:bg-background-dark dark:border-gray-700" />
          </div>
          <div>
            <label class="block text-xs mb-1">Phone</label>
            <input id="nwq_billToPhone" type="tel" placeholder="+1 555 123 4567" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400 bg-white dark:bg-background-dark dark:border-gray-700" />
          </div>
          <div>
            <label class="block text-xs mb-1">Currency</label>
            <select id="nwq_currency" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 bg-white dark:bg-background-dark dark:border-gray-700">
              <option value="TTD">TTD</option>
              <option value="USD">USD</option>
            </select>
          </div>
          <div class="md:col-span-6">
            <div id="nwq_items" class="grid gap-2">
              <div class="nwq-item-row md:col-span-6 grid md:grid-cols-6 gap-2">
                <div class="md:col-span-4">
                  <label class="block text-xs mb-1">Item Description</label>
                  <div class="space-y-2">
                    <select data-nwq="preset" class="border px-3 py-2 rounded w-full bg-white dark:bg-background-dark dark:border-gray-700 text-gray-900 dark:text-gray-100">
                      <option value="">Select an item…</option>
                      <optgroup label="Plans">
                        <option value="plan:Start">Start</option>
                        <option value="plan:Pro">Pro</option>
                        <option value="plan:Elite">Elite</option>
                        <option value="plan:E-Commerce Pro">E-Commerce Pro</option>
                      </optgroup>
                      <optgroup label="Add-ons">
                        <option value="addon:Advanced SEO & Local Positioning">Advanced SEO & Local Positioning</option>
                        <option value="addon:Blog / News Section">Blog / News Section</option>
                        <option value="addon:Small Online Store (up to 10 products)">Small Online Store (up to 10 products)</option>
                        <option value="addon:Extended Catalog (extra product blocks)">Extended Catalog (extra product blocks)</option>
                        <option value="addon:Basic Branding Package (one-time)">Basic Branding Package (one-time)</option>
                      </optgroup>
                      <option value="other">Other…</option>
                    </select>
                    <div class="nwq-desc-wrap hidden">
                      <input data-nwq="desc" placeholder="Custom description" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 placeholder:text-gray-600 dark:placeholder:text-gray-400 bg-white dark:bg-background-dark dark:border-gray-700" />
                    </div>
                  </div>
                </div>
                <div>
                  <label class="block text-xs mb-1">Qty</label>
                  <input data-nwq="qty" type="number" step="0.01" value="1" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 bg-white dark:bg-background-dark dark:border-gray-700" />
                </div>
                <div>
                  <label class="block text-xs mb-1">Unit Price</label>
                  <input data-nwq="price" type="number" step="0.01" value="0" class="border px-3 py-2 rounded w-full text-gray-900 dark:text-gray-100 bg-white dark:bg-background-dark dark:border-gray-700" />
                </div>
              </div>
            </div>
            <div class="mt-2 flex items-center justify-between gap-2">
              <div class="flex items-center gap-2">
                <span class="relative group">
                  <button id="nwq_addIconBtn" type="button" aria-label="Add item" class="inline-flex items-center justify-center w-10 h-10 rounded border hover:bg-slate-50 dark:hover:bg-background-dark/60">
                    <span class="material-symbols-outlined">add</span>
                  </button>
                  <span class="pointer-events-none invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-opacity absolute -top-2 -translate-y-full left-1/2 -translate-x-1/2 text-xs px-2 py-1 rounded bg-gray-900 text-white whitespace-nowrap">Add item</span>
                </span>
                <span class="relative group">
                  <button id="nwq_removeIconBtn" type="button" aria-label="Remove last item" class="inline-flex items-center justify-center w-10 h-10 rounded border hover:bg-slate-50 dark:hover:bg-background-dark/60">
                    <span class="material-symbols-outlined">remove</span>
                  </button>
                  <span class="pointer-events-none invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-opacity absolute -top-2 -translate-y-full left-1/2 -translate-x-1/2 text-xs px-2 py-1 rounded bg-gray-900 text-white whitespace-nowrap">Remove item</span>
                </span>
              </div>
              <div class="flex items-center gap-2">
                <button id="nwq_archiveBtn" type="button" class="px-3 py-2 rounded border text-sm">Archive</button>
                <button id="nwq_deleteBtn" type="button" class="px-3 py-2 rounded border text-sm text-white bg-red-600 border-red-600">Delete</button>
                <button class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold">Create quote</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Modal (Archive/Delete) -->
    <div id="adminConfirmModal" class="hidden fixed inset-0 z-[80] items-center justify-center">
      <div class="absolute inset-0 bg-black/50" data-confirm="backdrop"></div>
      <div class="relative bg-white dark:bg-background-dark rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 w-[92vw] max-w-md mx-auto p-5">
        <h3 id="adminConfirmTitle" class="text-lg font-bold mb-2">Confirm</h3>
        <p id="adminConfirmMessage" class="text-sm text-gray-700 dark:text-gray-300 mb-4">Are you sure?</p>
        <div class="flex items-center justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded border" data-confirm="cancel">Cancel</button>
          <button type="button" class="px-3 py-2 rounded text-white bg-primary" data-confirm="ok">Confirm</button>
        </div>
      </div>
    </div>

    <style is:inline>
      #adminSidebar.collapsed { width: 60px; }
      #adminSidebar .label { display: inline; }
      #adminSidebar.collapsed .label { display: none; }
      #adminSidebar nav a.admin-link { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem; color: rgb(51 65 85); }
      #adminSidebar nav a.admin-link:hover { background: rgba(148,163,184,0.15); }
      .dark #adminSidebar nav a.admin-link { color: rgb(203 213 225); }
      #adminSidebar nav a.admin-link.active { background: rgba(17,115,212,0.1); color: rgb(17,115,212); font-weight: 600; }
      #adminSidebar.collapsed nav a.admin-link { justify-content: center; }
      #sidebarToggleIcon { transition: transform 150ms ease; }
      #adminSidebar.collapsed #sidebarToggleIcon { transform: rotate(180deg); }
      @media (min-width: 768px) {
        #adminSidebar { transform: none !important; }
        #sidebarBackdrop { display: none !important; }
      }
    </style>
    <script type="module" src={adminUrl}></script>
  </body>
  
</html>



