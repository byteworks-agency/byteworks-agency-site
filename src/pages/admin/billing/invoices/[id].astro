---
import AdminBase from '../../../../layouts/AdminBase.astro';
const { id } = Astro.params;
const formatId = (value?: string | null, date = new Date()) => {
  if (!value) return '-';
  if (value.includes('-')) return value.toUpperCase();
  const cleaned = value.replace(/[^A-Za-z0-9]/g, '').slice(0, 6).toUpperCase() || 'XXXXXX';
  const y = date.getUTCFullYear();
  const m = String(date.getUTCMonth() + 1).padStart(2, '0');
  return `BW-${y}${m}-${cleaned}`;
};
const formattedId = formatId(id);
const title = `Invoice Details â€” ${formattedId}`;
---

<AdminBase title={title} description="Invoice Details" image="/og-image.png" lang="en">
  <section class="max-w-6xl mx-auto" data-invoice-id={id} data-invoice-label={formattedId}>
    <div class="flex items-center justify-between mb-6">
      <div>
        <a class="flex items-center text-sm text-gray-500 dark:text-gray-300 mb-2" href="/admin/billing/invoices">
          <span class="material-symbols-outlined text-base mr-1">arrow_back_ios</span>
          Back to Invoices
        </a>
        <p id="invTitle" class="text-4xl font-black tracking-[-0.033em] text-gray-900 dark:text-gray-100">Invoice #{formattedId}</p>
      </div>
      <div class="flex items-center gap-2">
        <button class="flex items-center gap-2 rounded-lg h-10 px-4 bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-100 text-sm font-bold" onclick="window.print()">
          <span class="material-symbols-outlined mr-1">print</span>
          Print PDF
        </button>
        <button class="flex items-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold" data-modal-toggle="payment-modal">
          Record payment
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="flex flex-col gap-1 rounded-lg p-6 border border-blue-500 dark:border-blue-400 bg-blue-50 dark:bg-blue-900/30">
        <p class="text-blue-800 dark:text-blue-200 text-base">Total</p>
        <p id="kpiTotal" class="text-blue-800 dark:text-blue-100 text-3xl font-bold">-</p>
      </div>
      <div class="flex flex-col gap-1 rounded-lg p-6 border border-green-500 dark:border-green-400 bg-green-50 dark:bg-green-900/30">
        <p class="text-green-800 dark:text-green-200 text-base">Paid</p>
        <p id="kpiPaid" class="text-green-800 dark:text-green-100 text-3xl font-bold">-</p>
      </div>
      <div class="flex flex-col gap-1 rounded-lg p-6 border border-orange-500 dark:border-orange-400 bg-orange-50 dark:bg-orange-900/30">
        <p class="text-orange-800 dark:text-orange-200 text-base">Balance</p>
        <p id="kpiBalance" class="text-orange-800 dark:text-orange-100 text-3xl font-bold">-</p>
      </div>
    </div>

    <div class="bg-white dark:bg-background-dark rounded-lg border border-gray-200 dark:border-gray-700 p-4">
      <h2 class="text-lg font-bold px-2 pb-3 text-gray-900 dark:text-gray-100">Payments</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-gray-800 dark:text-gray-100">
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300">
              <th class="px-4 py-3 text-left text-sm">Date</th>
              <th class="px-4 py-3 text-left text-sm">Method</th>
              <th class="px-4 py-3 text-left text-sm">Reference</th>
              <th class="px-4 py-3 text-left text-sm">Amount</th>
            </tr>
          </thead>
          <tbody id="paymentsBody"></tbody>
        </table>
        <div class="mt-3 text-right">
          <a id="exportPayments" class="text-sm underline text-primary" target="_blank">Export payments (CSV)</a>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-background-dark rounded-lg border border-gray-200 dark:border-gray-700 p-4 mt-8">
      <h2 class="text-lg font-bold px-2 pb-3 text-gray-900 dark:text-gray-100">Payment Reminder</h2>
      <div class="p-2">
        <div class="flex gap-2 mb-4">
          <button class="px-3 py-2 rounded bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-100" onclick="preview('due_Tminus3')">T-3 Days</button>
          <button class="px-3 py-2 rounded bg-primary text-white" onclick="preview('due_day0')">Due Day</button>
          <button class="px-3 py-2 rounded bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-100" onclick="preview('due_plus3')">T+3 Days</button>
        </div>
        <div class="relative">
          <textarea id="reminderText" readonly rows="8" class="w-full p-4 border border-gray-200 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-900 text-gray-700 dark:text-gray-100 text-sm"></textarea>
          <button class="absolute top-4 right-4 px-3 py-1.5 text-xs font-medium text-white bg-primary rounded shadow-sm" onclick="copyReminder()">
            <span class="material-symbols-outlined text-sm mr-1">content_copy</span>
            Copy
          </button>
        </div>
      </div>
    </div>

    <div id="payment-modal" class="hidden fixed inset-0 z-50 items-center justify-center">
      <div class="relative p-4 w-full max-w-2xl">
        <div class="relative bg-white dark:bg-background-dark rounded-lg border border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-start p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Record payment</h3>
            <button class="text-gray-500 dark:text-gray-300" data-modal-toggle="payment-modal" type="button"><span class="material-symbols-outlined">close</span></button>
          </div>
          <div class="p-6 space-y-6">
            <form onsubmit="event.preventDefault(); recordPayment();">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Amount</label>
                  <input id="amount" type="number" step="0.01" class="border border-gray-200 dark:border-gray-700 px-3 py-2 rounded w-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" />
                </div>
                <div>
                  <label class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Method</label>
                  <select id="method" class="border border-gray-200 dark:border-gray-700 px-3 py-2 rounded w-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
                    <option value="transfer">Bank Transfer</option>
                    <option value="cash">Cash</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Receipt Date</label>
                  <input id="receivedDate" type="datetime-local" class="border border-gray-200 dark:border-gray-700 px-3 py-2 rounded w-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" />
                </div>
                <div>
                  <label class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Reference</label>
                  <input id="ref" class="border border-gray-200 dark:border-gray-700 px-3 py-2 rounded w-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" />
                </div>
                <div class="md:col-span-2">
                  <label class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Notes</label>
                  <input id="notes" class="border border-gray-200 dark:border-gray-700 px-3 py-2 rounded w-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" />
                </div>
              </div>
              <div class="flex items-center gap-2 mt-4">
                <button class="px-4 py-2 bg-primary text-white rounded" type="submit">Save</button>
                <button class="px-4 py-2 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded" data-modal-toggle="payment-modal" type="button">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <pre id="out" class="mt-6 text-xs bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-100 border border-gray-200 dark:border-gray-700 p-3 rounded"></pre>
    <script is:inline>
      const root = document.querySelector('[data-invoice-id]');
      const INV_ID = (root?.dataset?.invoiceId ?? '').toString();
      const FALLBACK_LABEL = (root?.dataset?.invoiceLabel ?? '').toString();
      function toggleModal(id, forceClose) {
        const modal = document.getElementById(id);
        if (!modal) return;
        const shouldClose = forceClose ?? !modal.classList.contains('hidden');
        modal.classList.toggle('hidden', shouldClose);
        modal.classList.toggle('flex', !shouldClose);
      }
      document.querySelectorAll('[data-modal-toggle]').forEach((btn)=>{
        const target = btn.getAttribute('data-modal-toggle');
        if (!target) return;
        btn.addEventListener('click', ()=>toggleModal(target));
      });
      document.addEventListener('DOMContentLoaded', fetchInvoice);
      function fmt(cur, v){ return `${cur} ${v}`; }
      function prettyId(val, dateIso) {
        if (!val) return '-';
        if (val.includes('-')) return val.toUpperCase();
        const cleaned = val.replace(/[^A-Za-z0-9]/g, '').slice(0, 6).toUpperCase() || 'XXXXXX';
        const dt = dateIso ? new Date(dateIso) : new Date();
        const y = dt.getUTCFullYear();
        const m = String(dt.getUTCMonth() + 1).padStart(2, '0');
        return `BW-${y}${m}-${cleaned}`;
      }
      async function fetchInvoice(){
        if (!INV_ID) return;
        const res = await fetch(`/api/billing/invoices/${INV_ID}`);
        const j = await res.json().catch(()=>({}));
        if (!j || !j.ok) return;
        const d = j.data;
        document.getElementById('invTitle').textContent = `Invoice #${prettyId(d.number || d.id, d.issueDate)}`;
        document.getElementById('kpiTotal').textContent = fmt(d.currency, d.total);
        const paid = (Number(d.total) - Number(d.balance)).toFixed(2);
        document.getElementById('kpiPaid').textContent = fmt(d.currency, paid);
        document.getElementById('kpiBalance').textContent = fmt(d.currency, d.balance);
        const tbody = document.getElementById('paymentsBody'); tbody.innerHTML='';
        (d.payments||[]).forEach((p)=>{
          const tr = document.createElement('tr');
          tr.className='border-b border-gray-200 dark:border-gray-700';
          tr.innerHTML = `<td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-200">${p.receivedDate.slice(0,10)}</td><td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-200">${p.method}</td><td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-200">${p.ref}</td><td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-200">${d.currency} ${p.amount}</td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('exportPayments').setAttribute('href', `/api/billing/invoices/${d.id}/payments/export.csv`);
      }
      async function recordPayment(){
        if (!INV_ID) return;
        const amountEl = document.getElementById('amount');
        const methodEl = document.getElementById('method');
        const receivedEl = document.getElementById('receivedDate');
        const refEl = document.getElementById('ref');
        const notesEl = document.getElementById('notes');
        const rawDate = receivedEl && receivedEl.value ? receivedEl.value : '';
        if (!rawDate) { alert('Please select the receipt date.'); return; }
        const parsed = new Date(rawDate);
        if (Number.isNaN(parsed.getTime())) { alert('Invalid receipt date.'); return; }

        const payload = {
          invoiceId: INV_ID,
          amount: amountEl ? amountEl.value : '',
          method: methodEl ? methodEl.value : '',
          receivedDate: parsed.toISOString(),
          ref: refEl ? refEl.value : '',
          notes: (notesEl && notesEl.value) ? notesEl.value : undefined,
          source: 'invoice_manual',
        };
        const res = await fetch('/api/billing/payments/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await res.json();
        document.getElementById('out').textContent = JSON.stringify(j, null, 2);
        toggleModal('payment-modal', true);
        fetchInvoice();
      }
      async function preview(template){
        if (!INV_ID) return;
        const res = await fetch('/api/billing/reminders/preview', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ invoiceId: INV_ID, template }) });
        const j = await res.json();
        if (!j || !j.ok) return;
        const { textES, textEN } = j.data;
        (document.getElementById('reminderText')).value = `(ES)\n${textES}\n---\n(EN)\n${textEN}`;
      }
      function copyReminder(){
        const t = (document.getElementById('reminderText')).value;
        if (navigator.clipboard) navigator.clipboard.writeText(t||'');
      }
    </script>
  </section>
</AdminBase>
